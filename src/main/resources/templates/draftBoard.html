<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Draft Board</title>
    <link rel="icon" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      href="https://fonts.googleapis.com/css2?family=Doto:wght@400;700&family=VT323&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background-color: #1e1e1e;
        font-family: "Doto", sans-serif;
        color: #00ced1;
        overflow-x: hidden;
        overflow-y: auto;
        overscroll-behavior: none;
        touch-action: pan-y;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      html::-webkit-scrollbar,
      body::-webkit-scrollbar {
        display: none;
      }

      .draft-container {
        width: 100%;
        max-width: 100%;
        padding: 20px;
        box-sizing: border-box;
      }

      .round-pick-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #0c2c3a;
        box-shadow: 0 0 3px #90ee90, 0 0 6px #90ee90c8;
        border-radius: 8px;
        margin-bottom: 15px;
        color: #f0a500;
        font-weight: bold;
        font-size: 1.4rem;
        gap: 10px;
        text-align: center;
        flex-wrap: wrap;
      }

      .round-pick-info > div {
        flex: 1;
        min-width: 100px;
      }

      .clock-message {
        font-size: 1.2rem;
        color: #77dd77;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .team-columns {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        overflow-y: auto; /* show vertical scrollbar */
        max-height: 80vh;
        scrollbar-width: thin;
        scrollbar-color: #555 transparent;
        -ms-overflow-style: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }

      /* WebKit scrollbar styles for .team-columns */
      .team-columns::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      .team-columns::-webkit-scrollbar-track {
        background: transparent;
      }
      .team-columns::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      .team-columns::-webkit-scrollbar-thumb:hover {
        background-color: #777;
      }

      .team-column {
        flex: 0 0 auto;
        background-color: #1e1e1e;
        margin-right: 20px;
        min-width: 200px;
      }

      .team-column table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        animation: fadeIn 0.5s ease-in;
      }

      .team-column thead {
        background-color: #1a1a1a;
      }

      .team-column th {
        background-color: #0c2c3a;
        color: #f0a500;
        font-size: 0.9rem;
        padding: 2px;
        height: 35px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .team-column td {
        font-family: "VT323", monospace;
        text-align: center;
        font-size: 1.7rem;
        color: black;
        font-weight: 400;
        height: 100px;
        width: 150px;
      }

      .adp-list-container {
        position: fixed;
        top: 0;
        right: 0;
        width: 30%;
        height: 100%;
        background-color: #0c2c3a;
        border-left: 2px solid #f0a500;
        overflow-y: auto;
        z-index: 999;
        transition: transform 0.3s ease-in-out;
      }

      .adp-list-container table {
        width: 100%;
        border-collapse: collapse;
        animation: fadeIn 0.6s ease-in;
        table-layout: fixed;
      }

      .adp-list-container th {
        background-color: #1e1e1e;
        color: #f0a500;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 1.2rem;
        height: 35px;
        padding: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .adp-list-container td {
        font-family: "VT323", monospace;
        text-align: center;
        height: 80px;
        padding: 8px;
        color: #00ced1;
        border-bottom: 3px solid #1e1e1e;
      }

      .adp-list-container button.select-btn {
        font-family: "Doto", monospace;
        background-color: #1e1e1e;
        color: #00ced1;
        font-size: 0.8rem;
        width: 60px;
        font-weight: bolder;
        padding: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
      }

      .adp-list-container button.select-btn:hover {
        background-color: #2d677d;
        color: #f0a500;
        transform: scale(1.05);
      }

      .leave-draft-button {
        color: #f0a500;
        font-family: "Doto", sans-serif;
        font-size: 0.8rem;
        margin: 15px;
        font-weight: bold;
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background-color: #0c2c3a;
        transition: background-color 0.3s ease, transform 0.2s ease;
      }

      .leave-draft-button:hover {
        transform: scale(1.05);
      }

      .position-filter {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 2rem 0;
      }

      .position-filter-label {
        font-size: 1.6rem;
        font-weight: bold;
        color: #f0a500;
        margin-bottom: 25px;
        text-align: center;
      }

      .position-filter-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
      }

      .position-filter-buttons button {
        border: none;
        border-radius: 6px;
        font-weight: bold;
        padding: 10px 16px;
        font-size: 1rem;
        cursor: pointer;
        color: #1e1e1e;
        transition: transform 0.2s ease, background-color 0.3s ease;
      }

      .position-filter-buttons button[data-pos="QB"] {
        background-color: #ff6961;
      }

      .position-filter-buttons button[data-pos="WR"] {
        background-color: orange;
      }

      .position-filter-buttons button[data-pos="RB"] {
        background-color: #77dd77;
      }

      .position-filter-buttons button[data-pos="TE"] {
        background-color: yellow;
      }

      .position-filter-buttons button[data-pos="ALL"] {
        background-color: #dddddd;
      }

      .position-filter-buttons button:hover {
        transform: scale(1.05);
        opacity: 0.9;
      }

      .adp-toggle-button {
        position: fixed;
        top: 15px;
        right: 10px;
        z-index: 1000;
        color: #f0a500;
        font-family: "Doto", sans-serif;
        font-size: 0.8rem;
        font-weight: bold;
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background-color: #0c2c3a;
        transition: background-color 0.3s ease, transform 0.2s ease;
      }

      .adp-toggle-button:hover {
        transform: scale(1.05);
        background-color: #2d677d;
        color: #fff;
      }

      /* Responsive Styles */
      @media (max-width: 768px) {
        .round-pick-info {
          flex-direction: column;
          font-size: 1rem;
          padding: 10px;
        }

        .team-columns {
          flex-direction: row;
          overflow-x: auto;
        }

        .team-column {
          min-width: 140px;
          margin-right: 10px;
        }

        .team-column td {
          font-size: 1.1rem;
          height: 60px;
          width: auto;
        }

        .team-column th {
          font-size: 0.8rem;
        }

        .adp-list-container {
          width: 100%;
          transform: translateX(100%);
          position: fixed;
          left: 0;
          transition: transform 0.3s ease-in-out;
        }

        .adp-list-container.open {
          transform: translateX(0);
        }

        .position-filter-label {
          font-size: 1.2rem;
        }

        .position-filter-buttons button {
          font-size: 0.8rem;
          padding: 8px 10px;
        }

        .adp-list-container th,
        .adp-list-container td {
          font-size: 1rem;
        }

        .adp-list-container button.select-btn {
          width: 50px;
          font-size: 0.7rem;
        }
      }

      @media (min-width: 769px) {
        .adp-toggle-button {
          display: none;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div>
      <form
        th:action="@{/leave-draft}"
        method="get"
        onsubmit="return confirmLeaveDraft();"
      >
        <button type="submit" class="leave-draft-button">Leave Draft</button>
      </form>
    </div>
    <div class="draft-container">
      <div class="round-pick-info">
        <div>
          Round: <span id="roundNumberSpan" th:text="${roundNumber}"></span>
        </div>
        <div>
          Pick: <span id="currentPickSpan" th:text="${currentPick}"></span>
        </div>
        <div class="clock-message" id="clockMessage">&nbsp;</div>
      </div>

      <button class="adp-toggle-button" onclick="toggleAdpList()">
        Toggle ADP List
      </button>

      <div class="team-columns">
        <div th:each="team : ${session.mockTeams}" class="team-column">
          <table>
            <thead>
              <tr>
                <th th:text="${team.teamName}"></th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="player : ${team.roster}">
                <td>
                  <img
                    th:src="${player.espnHeadshot}"
                    alt="headshot"
                    style="width: 40px; height: 40px; border-radius: 50%"
                  />
                </td>
                <td th:text="${player.adpPlayer.name}"></td>
                <td th:text="${player.adpPlayer.position}"></td>
                <td th:text="${player.team}"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="adp-list-container">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>Pos</th>
            <th>PRank</th>
            <th></th>
          </tr>
          <tr>
            <!-- 🔍 POSITION FILTER CONTROLS -->
            <div class="position-filter">
              <div class="position-filter-label">
                <span th:text="${format.toUpperCase()} + ' ADP'"></span>
              </div>
              <div class="position-filter-buttons">
                <button type="button" data-pos="ALL">ALL</button>
                <button type="button" data-pos="QB">QB</button>
                <button type="button" data-pos="WR">WR</button>
                <button type="button" data-pos="RB">RB</button>
                <button type="button" data-pos="TE">TE</button>
              </div>
            </div>
          </tr>
        </thead>
        <tbody id="adpTableBody">
          <tr
            th:each="player : ${session.adpList}"
            th:attr="data-position=${player.adpPlayer.position}"
            th:attrappend="data-espn-headshot=${player.espnHeadshot}, data-team=${player.team}"
          >
            <td
              style="font-size: 1.6rem"
              th:text="${#numbers.formatDecimal(player.adpPlayer.overallRank, 0, 0)}"
            ></td>
            <td
              style="font-size: 1.1rem"
              th:text="${player.adpPlayer.name}"
            ></td>
            <td
              style="font-size: 1.6rem"
              th:text="${player.adpPlayer.position}"
            ></td>
            <td
              style="font-size: 1.6rem"
              th:text="${#numbers.formatDecimal(player.adpPlayer.positionalRank, 0, 0)}"
            ></td>
            <td>
              <button
                type="button"
                class="select-btn"
                th:attr="
    data-name=${player.adpPlayer.name},
    data-position=${player.adpPlayer.position},
    data-espn-headshot=${player.espnHeadshot},
    data-team=${player.team}
  "
              >
                DRAFT
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Hidden fields for JS -->
    <input type="hidden" id="userId" th:value="${userId}" />
    <input type="hidden" id="currentTeamId" th:value="${currentTeamId}" />
    <input type="hidden" id="currentPick" th:value="${currentPick}" />
    <input type="hidden" id="isReversed" th:value="${isReversed}" />
    <input type="hidden" id="roundNumber" th:value="${roundNumber}" />
    <input type="hidden" id="numOfSelections" th:value="${numOfSelections}" />
    <input type="hidden" id="numOfTeams" th:value="${numOfTeams}" />
    <input type="hidden" id="numOfRounds" th:value="${numOfRounds}" />

    <script>
      function toggleAdpList() {
        document.querySelector(".adp-list-container").classList.toggle("open");
      }

      window.addEventListener("unload", function () {
        navigator.sendBeacon("/leave-draft");
      });

      document.addEventListener("DOMContentLoaded", function () {
        const buttons = document.querySelectorAll(
          ".position-filter-buttons button"
        );

        buttons.forEach((button) => {
          button.addEventListener("click", function () {
            const position = button.getAttribute("data-pos");
            filterByPosition(position);
          });
        });

        function filterByPosition(position) {
          const rows = document.querySelectorAll("#adpTableBody tr");
          rows.forEach((row) => {
            const playerPos = row.getAttribute("data-position");
            if (position === "ALL" || playerPos === position) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        adjustTableWidths();
        checkTurn();
      });

      window.addEventListener("resize", adjustTableWidths);

      function confirmLeaveDraft() {
        return confirm(
          "Are you sure you want to leave the draft? Your progress will be lost."
        );
      }

      function adjustTableWidths() {
        const fixedWidth = 200;
        document.querySelectorAll(".team-column table").forEach((table) => {
          table.style.width = fixedWidth + "px";
        });
      }

      function checkTurn() {
        const userId = document.getElementById("userId").value;
        const currentTeamId = document.getElementById("currentTeamId").value;
        const draftButtons = document.querySelectorAll(".select-btn");

        if (userId === currentTeamId) {
          document.getElementById("clockMessage").textContent =
            "YOU ARE ON THE CLOCK!";
          draftButtons.forEach((btn) => (btn.disabled = false));
        } else {
          document.getElementById("clockMessage").textContent =
            "AUTO DRAFTING...";
          draftButtons.forEach((btn) => (btn.disabled = true));

          setTimeout(() => {
            const firstAvailableBtn =
              document.querySelector(".select-btn:not([disabled])") ||
              document.querySelector(".select-btn");
            if (!firstAvailableBtn) return;

            const payload = new URLSearchParams({
              selectedPlayerName: firstAvailableBtn.getAttribute("data-name"),
              userId,
              currentPick: document.getElementById("currentPick").value,
              isReversed: document.getElementById("isReversed").value,
              roundNumber: document.getElementById("roundNumber").value,
              numOfSelections: document.getElementById("numOfSelections").value,
              numOfTeams: document.getElementById("numOfTeams").value,
              numOfRounds: document.getElementById("numOfRounds").value,
              currentTeamId,
            });

            fetch("/draft/select", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: payload.toString(),
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.draftEnded) {
                  window.location.href = "/draft-over";
                  return;
                }

                document.getElementById("currentPick").value = data.currentPick;
                document.getElementById("currentTeamId").value =
                  data.currentTeamId;
                document.getElementById("numOfSelections").value =
                  data.numSelections;
                document.getElementById("isReversed").value = data.isReversed;
                document.getElementById("roundNumber").value = data.roundNumber;
                document.getElementById("roundNumberSpan").textContent =
                  data.roundNumber;
                document.getElementById("currentPickSpan").textContent =
                  data.currentPick;

                const player = data.selectedPlayer;
                if (!player) return;

                const btnToRemove = [
                  ...document.querySelectorAll(".select-btn"),
                ].find(
                  (btn) =>
                    btn.getAttribute("data-name").toLowerCase() ===
                    player.adpPlayer.name.toLowerCase()
                );
                if (btnToRemove) {
                  btnToRemove.closest("tr").remove();
                }

                const teamColumns = document.querySelectorAll(".team-column");
                const teamId = parseInt(currentTeamId);
                const targetTable = teamColumns[teamId]?.querySelector("tbody");

                if (targetTable) {
                  const newRow = document.createElement("tr");
                  newRow.style.backgroundColor = "#1e1e1e";

                  const cell = document.createElement("td");
                  cell.style.position = "relative";
                  cell.style.backgroundColor = getBackgroundColor(
                    player.adpPlayer.position
                  );
                  cell.style.borderRadius = "8px";
                  cell.style.display = "flex";
                  cell.style.alignItems = "center";
                  cell.style.overflow = "hidden";
                  cell.style.height = "100px";
                  cell.style.width = "200px";

                  const logoImg = document.createElement("img");
                  logoImg.src = `/images/${player.team}.png`;
                  logoImg.style.position = "absolute";
                  logoImg.style.top = "0";
                  logoImg.style.left = "20px";
                  logoImg.style.width = "60px";
                  logoImg.style.opacity = "0.4";
                  logoImg.style.zIndex = "0";
                  if (!player.team) logoImg.style.visibility = "hidden";
                  cell.appendChild(logoImg);

                  const img = document.createElement("img");
                  img.src = player.espnHeadshot || `/images/stockplayer.png`;
                  img.alt = "headshot";
                  img.style.width = "60px";
                  img.style.height = "80px";
                  img.style.objectFit = "cover";
                  img.style.alignSelf = "flex-end";
                  img.style.zIndex = "1";
                  img.style.marginLeft = "5px";
                  img.style.marginRight = "20px";
                  cell.appendChild(img);

                  const nameDiv = document.createElement("div");
                  nameDiv.style.display = "flex";
                  nameDiv.style.flexDirection = "column";
                  nameDiv.style.justifyContent = "center";
                  nameDiv.style.alignItems = "flex-start";
                  nameDiv.style.zIndex = "1";
                  nameDiv.style.flex = "1";

                  const [firstName, ...lastNameParts] =
                    player.adpPlayer.name.split(" ");
                  const lastName = lastNameParts.join(" ");

                  const firstNameSpan = document.createElement("span");
                  firstNameSpan.textContent = firstName;
                  firstNameSpan.style.fontSize = "1.2rem";

                  const lastNameSpan = document.createElement("span");
                  lastNameSpan.textContent = lastName;
                  lastNameSpan.style.fontWeight = "bolder";
                  lastNameSpan.style.fontSize = "1.8rem";
                  lastNameSpan.style.lineHeight = "1";

                  nameDiv.appendChild(firstNameSpan);
                  nameDiv.appendChild(lastNameSpan);
                  cell.appendChild(nameDiv);

                  const positionSpan = document.createElement("span");
                  positionSpan.textContent = player.adpPlayer.position;
                  positionSpan.style.position = "absolute";
                  positionSpan.style.top = "5px";
                  positionSpan.style.right = "10px";
                  positionSpan.style.fontSize = "1em";
                  positionSpan.style.fontWeight = "bold";
                  positionSpan.style.padding = "2px 6px";
                  positionSpan.style.borderRadius = "6px";
                  positionSpan.style.zIndex = "2";
                  cell.appendChild(positionSpan);

                  newRow.appendChild(cell);
                  targetTable.appendChild(newRow);
                }

                checkTurn();
              })
              .catch((err) => console.error("CPU pick error:", err.message));
          }, 1000);
        }
      }

      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("select-btn")) {
          const button = e.target;
          const playerName = button.getAttribute("data-name");
          const playerPosition = button.getAttribute("data-position");
          const espnHeadshot = button.getAttribute("data-espn-headshot");
          const team = button.getAttribute("data-team");
          button.disabled = true;

          const currentTeamId = document.getElementById("currentTeamId").value;

          const payload = new URLSearchParams({
            selectedPlayerName: playerName,
            userId: document.getElementById("userId").value,
            currentPick: document.getElementById("currentPick").value,
            isReversed: document.getElementById("isReversed").value,
            roundNumber: document.getElementById("roundNumber").value,
            numOfSelections: document.getElementById("numOfSelections").value,
            numOfTeams: document.getElementById("numOfTeams").value,
            numOfRounds: document.getElementById("numOfRounds").value,
            currentTeamId,
          });

          fetch("/draft/select", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: payload.toString(),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.draftEnded) {
                window.location.href = "/draft-over";
                return;
              }

              document.getElementById("currentPick").value = data.currentPick;
              document.getElementById("currentTeamId").value =
                data.currentTeamId;
              document.getElementById("numOfSelections").value =
                data.numSelections;
              document.getElementById("isReversed").value = data.isReversed;
              document.getElementById("roundNumber").value = data.roundNumber;
              document.getElementById("roundNumberSpan").textContent =
                data.roundNumber;
              document.getElementById("currentPickSpan").textContent =
                data.currentPick;

              button.closest("tr").remove();

              const teamColumns = document.querySelectorAll(".team-column");
              const teamId = parseInt(currentTeamId);
              const targetTable = teamColumns[teamId]?.querySelector("tbody");

              if (targetTable) {
                const newRow = document.createElement("tr");
                newRow.style.backgroundColor = "#1e1e1e";

                const cell = document.createElement("td");
                cell.style.position = "relative";
                cell.style.backgroundColor = getBackgroundColor(playerPosition);
                cell.style.borderRadius = "8px";
                cell.style.display = "flex";
                cell.style.alignItems = "center";
                cell.style.overflow = "hidden";
                cell.style.height = "100px";
                cell.style.width = "200px";

                const logoImg = document.createElement("img");
                logoImg.src = `/images/${team}.png`;
                logoImg.style.position = "absolute";
                logoImg.style.top = "0";
                logoImg.style.left = "20px";
                logoImg.style.width = "60px";
                logoImg.style.opacity = "0.4";
                logoImg.style.zIndex = "0";
                if (!team) logoImg.style.visibility = "hidden";
                cell.appendChild(logoImg);

                const img = document.createElement("img");
                img.src = espnHeadshot || `/images/stockplayer.png`;
                img.alt = "headshot";
                img.style.width = "60px";
                img.style.height = "80px";
                img.style.objectFit = "cover";
                img.style.alignSelf = "flex-end";
                img.style.zIndex = "1";
                img.style.marginLeft = "5px";
                img.style.marginRight = "20px";
                cell.appendChild(img);

                const nameDiv = document.createElement("div");
                nameDiv.style.display = "flex";
                nameDiv.style.flexDirection = "column";
                nameDiv.style.justifyContent = "center";
                nameDiv.style.alignItems = "flex-start";
                nameDiv.style.zIndex = "1";
                nameDiv.style.flex = "1";

                const [firstName, ...lastNameParts] = playerName.split(" ");
                const lastName = lastNameParts.join(" ");

                const firstNameSpan = document.createElement("span");
                firstNameSpan.textContent = firstName;
                firstNameSpan.style.fontSize = "1.2rem";

                const lastNameSpan = document.createElement("span");
                lastNameSpan.textContent = lastName;
                lastNameSpan.style.fontWeight = "bolder";
                lastNameSpan.style.fontSize = "1.8rem";
                lastNameSpan.style.lineHeight = "1";

                nameDiv.appendChild(firstNameSpan);
                nameDiv.appendChild(lastNameSpan);
                cell.appendChild(nameDiv);

                const positionSpan = document.createElement("span");
                positionSpan.textContent = playerPosition;
                positionSpan.style.position = "absolute";
                positionSpan.style.top = "5px";
                positionSpan.style.right = "10px";
                positionSpan.style.fontSize = "1em";
                positionSpan.style.fontWeight = "bold";
                positionSpan.style.padding = "2px 6px";
                positionSpan.style.borderRadius = "6px";
                positionSpan.style.zIndex = "2";
                cell.appendChild(positionSpan);

                newRow.appendChild(cell);
                targetTable.appendChild(newRow);
              }

              checkTurn();
            })
            .catch((err) => console.error("User pick error:", err.message));
        }
      });

      // Function to determine background color based on player position
      function getBackgroundColor(position) {
        switch (position) {
          case "QB":
            return "#ff6961";
          case "WR":
            return "orange";
          case "TE":
            return "yellow";
          case "RB":
            return "#77dd77";
          default:
            return "#222"; // Default background for other positions
        }
      }
    </script>
  </body>
</html>
